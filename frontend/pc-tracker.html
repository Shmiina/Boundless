<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PC Occupancy Tracker</title>
<style>
:root {
  --bg:#0d1117;
  --card:#0f1720;
  --muted:#9aa4b2;
  --accent:#58a6ff;
  --accent-2:#1f6feb;
  --glass: rgba(255,255,255,0.03);
  --text:#e6edf3;
}
[data-theme="light"] {
  --bg:#f5f7fa;
  --card:#ffffff;
  --muted:#5b6b78;
  --accent:#1a73e8;
  --accent-2:#1558b8;
  --glass: rgba(0,0,0,0.03);
  --text:#1a1a1a;
}
body {
  margin:0;
  font-family:Inter,sans-serif;
  background:var(--bg);
  color:var(--text);
  display:flex;
  justify-content:center;
  padding:16px;
}
.app {
  width:100%;
  max-width:960px;
  display:flex;
  flex-direction:column;
  gap:16px;
}
.card {
  background:var(--card);
  padding:14px;
  border-radius:12px;
  display:flex;
  flex-direction:column;
  gap:12px;
}
.pcs-grid {
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(180px,1fr));
  gap:12px;
}
.pc-card {
  background:var(--card);
  border:1px solid var(--glass);
  padding:12px;
  border-radius:8px;
}
.pc-title { font-size:18px; font-weight:600; margin-bottom:6px; }
.pc-status { font-size:14px; margin-bottom:6px; }
.btn {
  padding:6px 10px;
  border:none;
  background: var(--accent);
  color:#fff;
  border-radius:4px;
  cursor:pointer;
  margin-right:6px;
}
.btn:hover { background: var(--accent-2); }
.report-table {
  width:100%;
  border-collapse: collapse;
  margin-top:12px;
}
.report-table th, .report-table td {
  border:1px solid var(--glass);
  padding:8px;
  text-align:center;
}
.nav-buttons {
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:10px;
}
</style>
</head>
<body>
<div class="app">
  <div class="card">
    <h2>PC Occupancy Tracker</h2>

    <div class="nav-buttons">
      <button class="btn" onclick="location.href='index.html'">Leaderboard</button>
      <button class="btn" onclick="location.href='20plus.html'">Top 20+ Hours</button>
      <button class="btn" id="yesterdayReportBtn">Yesterday's Downtime Report</button>
      <button class="btn" id="resetNowBtn">Reset Now</button>
    </div>

    <div id="pcs" class="pcs-grid">Loading...</div>
    <button id="generateReport" class="btn" style="margin-top:10px;">Today's Report</button>
    <div id="reportContainer"></div>
  </div>
</div>

<script>
// ============================
// Config
// ============================
const HTTP_BASE = "https://boundless-backend-vo5t.onrender.com"; // Your Render backend
const WS_URL = "wss://boundless-backend-vo5t.onrender.com";

// ============================
// Render PCs
// ============================
const pcsContainer = document.getElementById("pcs");

function renderPCs(pcs) {
  pcsContainer.innerHTML = '';
  Object.keys(pcs).forEach(pc => {
    const { status, updatedBy, updatedAt } = pcs[pc];
    const card = document.createElement("div");
    card.className = "pc-card";
    card.innerHTML = `
      <div class="pc-title">${pc}</div>
      <div class="pc-status"><b>Status:</b> ${status}</div>
      <div><b>By:</b> ${updatedBy || "—"}</div>
      <div><b>At:</b> ${updatedAt ? new Date(updatedAt).toLocaleString() : "—"}</div>
      <div>
        <button class="btn" onclick="updatePC('${pc}','occupied')">Occupied</button>
        <button class="btn" onclick="updatePC('${pc}','free')">Free</button>
      </div>
    `;
    pcsContainer.appendChild(card);
  });
}

// ============================
// WebSocket
// ============================
const ws = new WebSocket(WS_URL);
ws.onopen = () => console.log("WS connected");
ws.onmessage = ev => {
  try {
    const msg = JSON.parse(ev.data);
    if(msg.type==='state') renderPCs(msg.data);
  } catch(e) { console.error(e); }
};

// ============================
// Fetch initial PC state
// ============================
async function loadInitial() {
  try {
    const res = await fetch(`${HTTP_BASE}/pcs`);
    const data = await res.json();
    renderPCs(data);
  } catch(e) {
    pcsContainer.innerHTML="<p style='color:red'>Failed to load PC data.</p>";
    console.error(e);
  }
}

// ============================
// Update PC status
// ============================
async function updatePC(pc, status) {
  let updatedBy = null;

  if(status === "occupied") {
    updatedBy = prompt("Your name (required to occupy):","");
    if(!updatedBy) return alert("Name is required to occupy the PC.");
  }

  try {
    await fetch(`${HTTP_BASE}/update`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({
        pc,
        status,
        updatedBy: status === "free" ? null : updatedBy
      })
    });
  } catch(e){
    console.error(e);
    alert("Failed to update PC");
  }
}

// ============================
// Reports
// ============================
document.getElementById("generateReport").addEventListener("click", async () => {
  await generateReport("today");
});

document.getElementById("yesterdayReportBtn").addEventListener("click", async () => {
  await generateReport("yesterday");
});

async function generateReport(day) {
  try {
    const res = await fetch(`${HTTP_BASE}/report?day=${day}`);
    const data = await res.json();
    let html = `<table class="report-table"><tr><th>PC</th><th>Total Uptime</th><th>Total Downtime</th></tr>`;
    Object.keys(data).forEach(pc => {
      html += `<tr><td>${pc}</td><td>${data[pc].totalUptime}</td><td>${data[pc].totalDowntime}</td></tr>`;
    });
    html += "</table>";
    document.getElementById("reportContainer").innerHTML = html;
  } catch(e) {
    console.error(e);
    alert(`Failed to generate ${day} report`);
  }
}

// ============================
// Auto Reset at Midnight
// ============================
function scheduleReset() {
  const now = new Date();
  const nextMidnight = new Date();
  nextMidnight.setHours(24,0,0,0); // next midnight
  const msToMidnight = nextMidnight - now;

  setTimeout(async () => {
    try {
      await fetch(`${HTTP_BASE}/reset`, { method:"POST" });
      console.log("PCs reset at midnight");
      loadInitial();
    } catch(e){ console.error(e); }

    // Schedule next reset
    scheduleReset();
  }, msToMidnight);
}

// Manual reset button
document.getElementById("resetNowBtn").addEventListener("click", async () => {
  try {
    await fetch(`${HTTP_BASE}/reset`, { method:"POST" });
    alert("PCs manually reset");
    loadInitial();
  } catch(e){ console.error(e); alert("Failed to reset"); }
});

// ============================
// Initial load
// ============================
loadInitial();
scheduleReset();
</script>
</body>
</html>
