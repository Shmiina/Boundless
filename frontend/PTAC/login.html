<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>User Dashboard</title>
  <style>
    body { font-family: Arial; }
    table { border-collapse: collapse; width: 80%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    input { width: 100%; box-sizing: border-box; }
    #dashboard { display: none; margin-top: 20px; }
    #loading { display: none; color: blue; margin-top: 10px; }
    button { margin: 5px; padding: 5px 10px; }
    .error { color: red; }
  </style>
</head>
<body>

<h2>Sign Up</h2>
<input type="text" id="signupUsername" placeholder="Enter ID">
<input type="password" id="signupPassword" placeholder="Enter Password">
<button onclick="signupUser()">Sign Up</button>

<h2>Login</h2>
<input type="text" id="username" placeholder="Enter ID">
<input type="password" id="password" placeholder="Enter Password">
<button onclick="loginUser()">Login</button>

<div id="loading">Loading...</div>
<div id="message" class="error"></div>

<div id="dashboard">
  <h3 id="welcome"></h3>
  <div id="data"></div>
  <button onclick="saveData()">Save Changes</button>
  <button onclick="logoutUser()">Logout</button>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwV5V6KsTG9lw6UfKbvEq1VprfGskXD_kglU0seyzPmw06arWxhQS5BGI5mh6cZLCTkIw/exec"; // Replace with your deployed script URL
let currentSheet = "";
let currentData = [];
let currentUsername = "";

function showLoading(isLoading) {
  document.getElementById("loading").style.display = isLoading ? "block" : "none";
  document.getElementById("message").innerText = "";
}

function showError(msg) {
  document.getElementById("message").innerText = msg;
}

// Signup
async function signupUser() {
  const username = document.getElementById("signupUsername").value.trim();
  const password = document.getElementById("signupPassword").value.trim();
  if (!username || !password) { showError("Enter ID and password"); return; }

  showLoading(true);
  try {
    const response = await fetch(WEB_APP_URL, {
      method: "POST",
      mode: "cors",
      body: JSON.stringify({action: "signup", username, password}),
      headers: { "Content-Type": "application/json" }
    });
    const result = await response.text();
    alert(result);
  } catch (err) {
    showError("Signup failed: " + err.message);
  } finally { showLoading(false); }
}

// Login
async function loginUser() {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  if (!username || !password) { showError("Enter ID and password"); return; }

  showLoading(true);
  try {
    const response = await fetch(WEB_APP_URL, {
      method: "POST",
      mode: "cors",
      body: JSON.stringify({action: "login", username, password}),
      headers: { "Content-Type": "application/json" }
    });
    const result = await response.json();
    if (result.error || !result.sheetName) { showError(result.error || "Login failed"); return; }

    currentSheet = result.sheetName;
    currentData = result.data;
    currentUsername = username;

    document.getElementById("dashboard").style.display = "block";
    document.getElementById("welcome").innerText = "Welcome, " + username;
    renderTable(currentData);

  } catch (err) { showError("Login failed: " + err.message); }
  finally { showLoading(false); }
}

// Render table
function renderTable(data) {
  let html = "<table><tr>";
  data[0].forEach(header => html += `<th>${header}</th>`);
  html += "</tr>";

  for (let i = 1; i < data.length; i++) {
    html += "<tr>";
    for (let j = 0; j < 8; j++) {
      html += `<td><input type='text' value='${data[i][j] || ""}' data-row='${i}' data-col='${j}'></td>`;
    }
    html += "</tr>";
  }
  html += "</table>";
  document.getElementById("data").innerHTML = html;
}

// Save data
async function saveData() {
  const inputs = document.querySelectorAll("#data input");
  const updated = [];
  updated.push(currentData[0]); // headers
  const temp = [];
  inputs.forEach(input => {
    const row = parseInt(input.dataset.row);
    const col = parseInt(input.dataset.col);
    if (!temp[row]) temp[row] = [];
    temp[row][col] = input.value;
  });
  for (let i = 1; i < temp.length; i++) updated.push(temp[i]);

  showLoading(true);
  try {
    const response = await fetch(WEB_APP_URL, {
      method: "POST",
      mode: "cors",
      body: JSON.stringify({action: "update", sheetName: currentSheet, updatedData: updated}),
      headers: { "Content-Type": "application/json" }
    });
    const result = await response.text();
    alert(result);
  } catch(err) { showError("Save failed: " + err.message); }
  finally { showLoading(false); }
}

// Logout
async function logoutUser() {
  showLoading(true);
  try {
    const response = await fetch(WEB_APP_URL, {
      method: "POST",
      mode: "cors",
      body: JSON.stringify({action: "logout", username: currentUsername}),
      headers: { "Content-Type": "application/json" }
    });
    const result = await response.text();
    alert(result);

    document.getElementById("dashboard").style.display = "none";
    document.getElementById("data").innerHTML = "";
    currentSheet = "";
    currentData = [];
    currentUsername = "";

  } catch(err) { showError("Logout failed: " + err.message); }
  finally { showLoading(false); }
}
</script>

</body>
</html>
