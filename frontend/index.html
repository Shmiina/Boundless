<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PC Occupancy Tracker & Leaderboard</title>
<style>
:root {
  --bg:#0d1117;
  --card:#0f1720;
  --muted:#9aa4b2;
  --accent:#58a6ff;
  --accent-2:#1f6feb;
  --glass: rgba(255,255,255,0.03);
  --text:#e6edf3;
}
[data-theme="light"] {
  --bg:#f5f7fa;
  --card:#ffffff;
  --muted:#5b6b78;
  --accent:#1a73e8;
  --accent-2:#1558b8;
  --glass: rgba(0,0,0,0.03);
  --text:#1a1a1a;
}
body {
  margin:0;
  font-family:Inter,sans-serif;
  background:var(--bg);
  color:var(--text);
  display:flex;
  justify-content:center;
  padding:16px;
}
.app {
  width:100%;
  max-width:960px;
  display:flex;
  flex-direction:column;
  gap:16px;
}
.topbar {
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  gap:8px;
}
.search input {
  width:100%;
  padding:10px 12px;
  border-radius:10px;
  border:1px solid var(--glass);
  font-size:14px;
  background:var(--card);
  color:inherit;
}
.theme-select {
  padding:10px;
  border-radius:10px;
  background:var(--card);
  color:inherit;
  border:1px solid var(--glass);
}
.card {
  background:var(--card);
  padding:14px;
  border-radius:12px;
  display:flex;
  flex-direction:column;
  gap:12px;
}
.leaderboard {
  display:flex;
  flex-direction:column;
  gap:8px;
}
.player {
  display:flex;
  align-items:center;
  padding:10px;
  border-radius:10px;
  background:var(--glass);
}
.button {
  padding:8px 14px;
  border-radius:10px;
  border:none;
  background:var(--accent);
  color:#fff;
  cursor:pointer;
  font-weight:600;
}
.button:hover { background: var(--accent-2); }

.pcs-grid {
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(180px,1fr));
  gap:12px;
}
.pc-card {
  background:var(--card);
  border:1px solid var(--glass);
  padding:12px;
  border-radius:8px;
}
.pc-title { font-size:18px; font-weight:600; margin-bottom:6px; }
.pc-status { font-size:14px; margin-bottom:6px; }
.btn {
  padding:6px 10px;
  border:1px solid var(--accent);
  background:var(--bg);
  border-radius:4px;
  cursor:pointer;
  font-size:14px;
  margin-right:6px;
}
.btn:hover { background: var(--accent); color:#fff; }

</style>
</head>
<body>
<div class="app">

  <!-- Topbar -->
  <div class="topbar">
    <div class="search">
      <input id="mainSearch" placeholder="Search players...">
    </div>
    <select id="themeSelect" class="theme-select">
      <option value="auto">Auto</option>
      <option value="dark">Dark</option>
      <option value="light">Light</option>
    </select>
  </div>

  <!-- Leaderboard Card -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3>Leaderboard</h3>
    </div>
    <select id="charSelect" class="theme-select">
      <option value="Nami">Nami</option>
      <option value="Pia">Pia</option>
      <option value="FREDDIE">Freddie</option>
      <option value="HAE">Hae</option>
    </select>
    <div id="leaderboardDiv" class="leaderboard"></div>
  </div>

  <!-- PC Tracker -->
  <div class="card">
    <h3>PC Occupancy Tracker</h3>
    <div id="pcs" class="pcs-grid">Loading...</div>
  </div>

</div>

<script>
// ============================
// Config
// ============================
const apiUrl = "https://script.google.com/macros/s/AKfycbwOtTP8TgoM6URjfUNLqK0962-wRAP4IDHlKQApNvpov6dH7A7fxmrKSZ45hg_mKGBIaA/exec"; // Google Apps Script URL
const HTTP_BASE = "https://your-backend.up.railway.app"; // Railway backend
const WS_URL = "wss://your-backend.up.railway.app";

// ============================
// Theme
// ============================
let themeMode = localStorage.getItem('ph_theme') || 'auto';
function applyTheme(mode){
  document.documentElement.setAttribute('data-theme',
    mode==='auto'? (window.matchMedia('(prefers-color-scheme: light)').matches?'light':'dark') : mode
  );
}
applyTheme(themeMode);
document.getElementById('themeSelect').value = themeMode;
document.getElementById('themeSelect').addEventListener('change', e=>{
  themeMode = e.target.value;
  localStorage.setItem('ph_theme', themeMode);
  applyTheme(themeMode);
});

// ============================
// Leaderboard (Google Apps Script)
// ============================
let mergedData = [], allData = [];

async function fetchAll(){
  const chars = ['Nami','Pia','FREDDIE','HAE'];
  const reqs = chars.map(c =>
    fetch(`${apiUrl}?leaderboard=${c}`)
      .then(r=>r.json())
      .catch(()=>[])
  );
  const res = await Promise.all(reqs);
  const flat = res.flatMap((arr,i) =>
    (arr||[]).map(p => ({
      id: p.id,
      name: p.name,
      hours: Number(p.hours),
      character: chars[i]
    }))
  );
  allData = flat;

  const map = new Map();
  flat.forEach(p => {
    if(!map.has(p.id) || p.hours > map.get(p.id).hours) map.set(p.id,p);
  });
  mergedData = [...map.values()];
}

function renderLeaderboard(char){
  const box = document.getElementById('leaderboardDiv');
  box.innerHTML = '';
  const list = mergedData.filter(p => p.character===char)
                         .sort((a,b)=>b.hours-a.hours)
                         .slice(0,10);

  const html = list.map((p,i)=>`
    <div class="player">
      <div style="width:30px;text-align:right;margin-right:10px;font-weight:600;color:var(--muted)">${i+1}.</div>
      <div style="flex:1">${p.name}<br><span style='font-size:12px;color:var(--muted)'>ID: ${p.id}</span></div>
      <div>${p.hours} hrs</div>
    </div>`).join('');
  box.innerHTML = html;
}

// Search
document.getElementById('mainSearch').addEventListener('input', e=>{
  const q = e.target.value.toLowerCase();
  const box = document.getElementById('leaderboardDiv');
  const list = allData.filter(p => p.name.toLowerCase().includes(q) || p.id.toLowerCase().includes(q)).slice(0,20);
  const html = list.map((p,i)=>`
    <div class="player">
      <div style="width:30px;text-align:right;margin-right:10px;font-weight:600;color:var(--muted)">${i+1}.</div>
      <div style="flex:1">${p.name}<br><span style='font-size:12px;color:var(--muted)'>ID: ${p.id} • ${p.character}</span></div>
      <div>${p.hours} hrs</div>
    </div>`).join('');
  box.innerHTML = html;
});

fetchAll().then(()=>renderLeaderboard('Nami'));
document.getElementById('charSelect').addEventListener('change', e=>renderLeaderboard(e.target.value));

// ============================
// PC Tracker
// ============================
const pcsContainer = document.getElementById('pcs');

function renderPCs(pcs){
  pcsContainer.innerHTML = '';
  Object.keys(pcs).forEach(pc=>{
    const {status, updatedBy, updatedAt} = pcs[pc];
    const card = document.createElement('div');
    card.className='pc-card';
    card.innerHTML=`
      <div class="pc-title">${pc}</div>
      <div class="pc-status"><b>Status:</b> ${status}</div>
      <div><b>By:</b> ${updatedBy || "—"}</div>
      <div><b>At:</b> ${updatedAt ? new Date(updatedAt).toLocaleString() : "—"}</div>
      <div>
        <button class="btn" onclick="updatePC('${pc}','occupied')">Occupied</button>
        <button class="btn" onclick="updatePC('${pc}','free')">Free</button>
      </div>
    `;
    pcsContainer.appendChild(card);
  });
}

// WebSocket connection
const ws = new WebSocket(WS_URL);
ws.onopen = () => console.log('WS connected');
ws.onmessage = ev => {
  try{
    const msg = JSON.parse(ev.data);
    if(msg.type==='state') renderPCs(msg.data);
  } catch(e){ console.error(e); }
};

// Fetch initial PC state
async function loadInitial(){
  try{
    const res = await fetch(`${HTTP_BASE}/pcs`);
    const data = await res.json();
    renderPCs(data);
  } catch(e){
    pcsContainer.innerHTML="<p style='color:red'>Failed to load PC data.</p>";
    console.error(e);
  }
}

// Update PC
async function updatePC(pc, status){
  const name = prompt("Your name (optional):","");
  try{
    await fetch(`${HTTP_BASE}/update`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({pc,status,updatedBy:name || null})
    });
  } catch(e){ console.error(e); alert("Failed to update PC"); }
}

loadInitial();
</script>
</body>
</html>
