<!-- Full Overhauled HTML/JS Leaderboard System with Lookup, Character Leaderboards, and 20+ Hours Tab -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Leaderboard System</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f5f5f5;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
    }

    .app-card {
        width: 420px;
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 15px;
    }

    .tabs button {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 6px;
        background: #ddd;
        cursor: pointer;
        transition: .2s;
    }

    .tabs button.active {
        background: #4CAF50;
        color: white;
    }

    .tab {
        display: none;
        animation: fade .3s;
    }

    @keyframes fade {
        from {opacity: 0;} to {opacity: 1;}
    }

    .title {
        font-size: 22px;
        font-weight: bold;
        margin-bottom: 12px;
    }

    .leaderboard .player {
        background: #fafafa;
        display: flex;
        justify-content: space-between;
        padding: 10px 14px;
        border-radius: 6px;
        margin-bottom: 6px;
        border: 1px solid #ddd;
    }

    .spinner {
        width: 30px;
        height: 30px;
        border: 4px solid #ccc;
        border-top: 4px solid #4CAF50;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }

    @keyframes spin {
        100% { transform: rotate(360deg); }
    }
</style>
</head>
<body>
<div class="app-card">

    <div class="tabs">
        <button id="tabLookup" onclick="showTab('lookup')">Lookup</button>
        <button id="tabLeaderboard" onclick="showTab('leaderboard')">Leaderboard</button>
        <button id="tabOver20" onclick="showTab('over20')">20+ Hours</button>
    </div>

    <!-- LOOKUP TAB -->
    <div id="lookup" class="tab">
        <div class="title">Player Lookup</div>
        <input id="lookupInput" placeholder="Enter Player ID" />
        <button onclick="lookupPlayer()">Search</button>
        <div id="lookupResult"></div>
    </div>

    <!-- CHARACTER LEADERBOARD TAB -->
    <div id="leaderboard" class="tab">
        <div class="title">Leaderboard</div>
        <select id="charSelect" onchange="loadLeaderboard()">
            <option value="Nami">Nami</option>
            <option value="Pia">Pia</option>
            <option value="FREDDIE">FREDDIE</option>
        </select>
        <div id="leaderboardDiv" class="leaderboard"></div>
    </div>

    <!-- 20+ HOURS TAB -->
    <div id="over20" class="tab">
        <div class="title">Players with 20+ Hours</div>
        <div id="over20Div" class="leaderboard"></div>
    </div>

</div>

<script>
const apiUrl = "https://script.google.com/macros/s/AKfycbwOtTP8TgoM6URjfUNLqK0962-wRAP4IDHlKQApNvpov6dH7A7fxmrKSZ45hg_mKGBIaA/exec";

function showTab(name) {
    document.querySelectorAll('.tab').forEach(t => t.style.display = 'none');
    document.getElementById(name).style.display = 'block';

    document.querySelectorAll('.tabs button').forEach(btn => btn.classList.remove('active'));
    document.getElementById("tab" + name.charAt(0).toUpperCase() + name.slice(1)).classList.add('active');

    if (name === "leaderboard") loadLeaderboard();
    if (name === "over20") loadOver20();
}

function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m]));
}

async function loadLeaderboard() {
    const char = document.getElementById("charSelect").value;
    const lb = document.getElementById("leaderboardDiv");
    lb.innerHTML = '<div class="spinner"></div>';

    try {
        const res = await fetch(`${apiUrl}?leaderboard=${char}`);
        const data = await res.json();

        lb.innerHTML = "";
        data.forEach((p, i) => {
            const div = document.createElement("div");
            div.className = "player";
            div.innerHTML = `
                <span>#${i+1} ${escapeHtml(p.id)}</span>
                <span>${escapeHtml(p.name)}</span>
                <span>${Number(p.hours).toFixed(2)} hrs</span>`;
            lb.appendChild(div);
        });
    } catch(e) {
        lb.innerHTML = "Failed to load leaderboard.";
    }
}

async function lookupPlayer() {
    const id = document.getElementById("lookupInput").value;
    const result = document.getElementById("lookupResult");
    result.innerHTML = '<div class="spinner"></div>';

    try {
        const res = await fetch(`${apiUrl}?id=${id}`);
        const data = await res.json();

        result.innerHTML = `
            <b>Name:</b> ${escapeHtml(data.name)}<br>
            <b>Hours:</b> ${Number(data.hours).toFixed(2)} hrs`;
    } catch(e) {
        result.innerHTML = "Player not found.";
    }
}

async function loadOver20() {
    const div = document.getElementById("over20Div");
    div.innerHTML = '<div class="spinner"></div>';

    const chars = ['Nami', 'Pia', 'FREDDIE'];

    try {
        const fetchPromises = chars.map(ch =>
            fetch(`${apiUrl}?leaderboard=${ch}`)
                .then(r => r.json())
                .catch(() => [])
        );

        const results = await Promise.all(fetchPromises);
        const merged = results.flat();

        const filtered = merged
            .map(p => ({id: p.id, name: p.name, hours: Number(p.hours)}))
            .filter(p => p.hours >= 20 && !isNaN(p.hours))
            .sort((a, b) => b.hours - a.hours);

        if (!filtered.length) {
            div.innerHTML = "No players have 20+ hours.";
            return;
        }

        div.innerHTML = "";
        filtered.forEach((p, i) => {
            const row = document.createElement("div");
            row.className = "player";
            row.innerHTML = `
                <span>#${i+1} ${escapeHtml(p.id)}</span>
                <span>${escapeHtml(p.name)}</span>
                <span>${p.hours.toFixed(2)} hrs</span>`;
            div.appendChild(row);
        });

    } catch (e) {
        div.innerHTML = "Error loading 20+ hour list.";
    }
}

showTab('lookup');
</script>
</body>
</html>
