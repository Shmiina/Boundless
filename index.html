<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Player Hours — Leaderboard</title>
<style>
:root{
  --bg:#0d1117; --card:#0f1720; --muted:#9aa4b2; --accent:#58a6ff; --accent-2:#1f6feb; --glass: rgba(255,255,255,0.03);
}
[data-theme="light"] {
  --bg: #f5f7fa;
  --card: #ffffff;
  --muted: #5b6b78;
  --accent: #1a73e8;
  --accent-2: #1558b8;
  --glass: rgba(0,0,0,0.03);
  --text: #1a1a1a; /* Add this for normal text in light mode */
  --border: rgba(0,0,0,0.08); /* For input and card borders */
}
body {
  color: var(--text, #e6edf3); /* fallback to dark mode default */
}

.search input, .theme-select, .button {
  border: 1px solid var(--border, rgba(255,255,255,0.08));
  background: var(--card);
  color: var(--text, #e6edf3);
}

.player {
  background: var(--glass);
  color: var(--text, #e6edf3);
}

body{
  margin:0;
  font-family:Inter, sans-serif;
  background:var(--bg);
  color:#e6edf3;
  display:flex;
  justify-content:center;
  padding:16px;
}
.app{width:100%;max-width:960px;display:flex;flex-direction:column;gap:16px;}
.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  gap:8px;
}
.search input{
  width:100%;
  padding:10px 12px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.08);
  font-size:14px;
  background:var(--card);
  color:inherit;
}
.theme-select{
  padding:10px;
  border-radius:10px;
  background:var(--card);
  color:inherit;
  border:1px solid rgba(255,255,255,0.08);
}
.card{
  background:var(--card);
  padding:14px;
  border-radius:12px;
  display:flex;
  flex-direction:column;
  gap:12px;
}
.leaderboard{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.player{
  display:flex;
  justify-content:space-between;
  padding:10px;
  border-radius:10px;
  background:var(--glass);
}
.button{
  padding:8px 14px;
  border-radius:10px;
  border:none;
  background:var(--accent);
  color:#fff;
  cursor:pointer;
  font-weight:600;
}
.button:hover{background:var(--accent-2);}
@media(max-width:800px){
  .app{flex-direction:column;}
  .topbar{flex-direction:column;}
  .card{flex-direction:column;}
}
</style>
</head>
<body>
<div class="app">

  <!-- Topbar -->
  <div class="topbar">
    <div class="search">
      <input id="mainSearch" placeholder="Search players..." />
    </div>
    <select id="themeSelect" class="theme-select">
      <option value="auto">Auto</option>
      <option value="dark">Dark</option>
      <option value="light">Light</option>
    </select>
  </div>

  <!-- Leaderboard Card -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3>Leaderboard</h3>
      <a href="20plus.html"><button class="button">Top Players 20+</button></a>
    </div>
    <select id="charSelect" class="theme-select">
      <option value="Nami">Nami</option>
      <option value="Pia">Pia</option>
      <option value="FREDDIE">FREDDIE</option>
    </select>
    <div id="leaderboardDiv" class="leaderboard"></div>
  </div>
</div>

<script>
const apiUrl = "https://script.google.com/macros/s/AKfycbwOtTP8TgoM6URjfUNLqK0962-wRAP4IDHlKQApNvpov6dH7A7fxmrKSZ45hg_mKGBIaA/exec";
let mergedData = [], allData = [], themeMode = localStorage.getItem('ph_theme') || 'auto';

// Theme
function applyTheme(mode){
  document.documentElement.setAttribute('data-theme',
    mode==='auto'? (window.matchMedia('(prefers-color-scheme: light)').matches?'light':'dark') : mode
  );
}
applyTheme(themeMode);
document.getElementById('themeSelect').value = themeMode;
document.getElementById('themeSelect').addEventListener('change', e=>{
  themeMode = e.target.value;
  localStorage.setItem('ph_theme', themeMode);
  applyTheme(themeMode);
});

// Helpers
function numberFmt(n){ return (Number(n)||0).toFixed(2); }
function escapeHtml(s){ return String(s).replace(/</g,'&lt;'); }

// Fetch
async function fetchAll(){
  const chars=['Nami','Pia','FREDDIE'];
  const reqs=chars.map(c=>fetch(apiUrl+'?leaderboard='+c).then(r=>r.json()).catch(()=>[]));
  const res=await Promise.all(reqs);
  const flat=res.flatMap((arr,i)=>(arr||[]).map(p=>({id:p.id,name:p.name,hours:Number(p.hours),character:chars[i]})));
  allData = flat;
  const map=new Map();
  flat.forEach(p=>{if(!map.has(p.id)||p.hours>map.get(p.id).hours) map.set(p.id,p)});
  mergedData=[...map.values()];
}

// Render
function renderLeaderboard(char){
  const box=document.getElementById('leaderboardDiv');
  box.innerHTML='';
  const list=mergedData.filter(p=>p.character===char).sort((a,b)=>b.hours-a.hours).slice(0,10);
  const html = list.map(p=>`
    <div class="player">
      <div>${escapeHtml(p.name)}<br><span style='font-size:12px;color:var(--muted)'>ID: ${escapeHtml(p.id)}</span></div>
      <div>${numberFmt(p.hours)} hrs</div>
    </div>`).join('');
  box.innerHTML = html;
}

// Search
function search(q){
  q=q.toLowerCase();
  const box=document.getElementById('leaderboardDiv');
  box.innerHTML='';
  const list=allData.filter(p=>p.name.toLowerCase().includes(q)||p.id.toLowerCase().includes(q)).slice(0,20);
  const html = list.map(p=>`
    <div class="player">
      <div>${escapeHtml(p.name)}<br><span style='font-size:12px;color:var(--muted)'>ID: ${escapeHtml(p.id)} • ${p.character}</span></div>
      <div>${numberFmt(p.hours)} hrs</div>
    </div>`).join('');
  box.innerHTML = html;
}

// Initialize
fetchAll().then(()=>renderLeaderboard('Nami'));
document.getElementById('charSelect').addEventListener('change', e=>renderLeaderboard(e.target.value));
document.getElementById('mainSearch').addEventListener('input', e=>search(e.target.value));
</script>
</body>
</html>
